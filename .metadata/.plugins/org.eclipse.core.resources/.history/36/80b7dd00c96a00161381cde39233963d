package com.hongchaegojung.railro.controllers;

import java.io.FileOutputStream;
import java.io.IOException;
import java.security.Principal;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import org.apache.ibatis.session.SqlSession;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;

import com.hongchaegojung.railro.dao.BoardDAO;
import com.hongchaegojung.railro.dto.Board;
import com.hongchaegojung.railro.dto.BoardFile;

@Controller
@RequestMapping("/railro/*")
public class RailroController {
	
	@Autowired
	private SqlSession sqlSession;
	
	@RequestMapping(value={"railroList.htm"}, method=RequestMethod.GET)
	public String test1() {
		return "railro.railroList";
	}
	
	// method=RequestMethod 를 쓰지 않으면 GET, POST 방식 둘 다 받을 수 있음
	@RequestMapping(value={"railroDetail.htm"})
	public String insert(
			Board board, HttpServletRequest request, Principal principal,
			// required = false : 파일 첨부가 필수는 아니다, true : 파일 첨부 필수
			// file 은 IOException 을 던져야 함. 그렇지 않으면 에러뜸
			@RequestParam(value="file", required=false) List<MultipartFile> files
			) throws ClassNotFoundException, SQLException, IOException {
		
		List<BoardFile> boardFiles = new ArrayList<BoardFile>();
		
		board.setWRITER(principal.getName());
		BoardDAO boardDAO = sqlSession.getMapper(BoardDAO.class);
		boardDAO.insert(board);
		
		for(MultipartFile file : files){
			
			if(file != null && !file.isEmpty()){
				
				String fname = file.getOriginalFilename();
				String path  = request.getServletContext().getRealPath("/customer/upload");
				String fpath = path + "\\" + fname;
				
				FileOutputStream fs = new FileOutputStream(fpath);
				fs.write(file.getBytes());
				fs.close();
				
				BoardFile boardFile = new BoardFile();
				boardFile.setORIGINFILENAME(file.getOriginalFilename());
			
				
				int boardId = boardDAO.lastKey();
				boardFile.setBOARDID(boardId);
				
				boardDAO.insertFile(boardFile);
				
			}
			
		}
		
		board.setBoardFile(boardFiles);
		
		
		return "railro.railroDetail";
	}
	
	@RequestMapping(value={"railroEdit.htm"}, method=RequestMethod.GET)
	public String test3() {
		return "railro.railroEdit";
	}
	
	@RequestMapping(value={"railroReg.htm"}, method=RequestMethod.GET)
	public String test4() {
		
		
		return "railro.railroReg";
	}
	
	@RequestMapping(value={"railroSearchList.htm"}, method=RequestMethod.GET)
	public String test5() {
		return "railro.railroSearchList";
	}
	
	
}
